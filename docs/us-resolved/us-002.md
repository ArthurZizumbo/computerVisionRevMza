# US-002: Inicialización de DVC y GCS

> **Estado:** ✅ Completada
> **Sprint:** 1 - Fundamentos y Adquisición de Datos
> **Fecha de Implementación:** 2025-11-28

---

## Resumen

Se configuró DVC con Google Cloud Storage como remote para versionado de datos y modelos del proyecto Geo-Rect.

---

## Criterios de Aceptación

- [x] DVC inicializado en el repositorio (`.dvc/` configurado)
- [x] Bucket GCS creado: `gs://geo-rect-artifacts`
- [x] Lifecycle policy configurada (30 días para objetos temporales)
- [x] DVC remote configurado apuntando a GCS como default
- [x] Service Account con permisos mínimos (Storage Object Admin)
- [x] Credenciales GCP configuradas de forma segura (no en Git)
- [x] Ciclo completo funcional: `dvc add` → `dvc push` → `rm` → `dvc pull`
- [x] Documentación de comandos y configuración

---

## Configuración Implementada

### Bucket GCS

- **Nombre:** `gs://geo-rect-artifacts`
- **Región:** `us-central1`
- **Storage Class:** `STANDARD`
- **Acceso:** Uniform bucket-level access

### Lifecycle Policy

| Condición | Acción | Prefijos |
|-----------|--------|----------|
| age > 30 días | Delete | `tmp/`, `cache/` |
| age > 90 días | SetStorageClass → NEARLINE | `data/raw/`, `models/archive/` |

### Service Account

- **Nombre:** `geo-rect-dvc@ine-ubica-tu-casilla.iam.gserviceaccount.com`
- **Rol:** `roles/storage.objectAdmin`
- **Credenciales:** `credentials/gcp-dvc-key.json` (no en Git)

### DVC Config

```ini
[core]
    remote = storage
    autostage = true
['remote "storage"']
    url = gs://geo-rect-artifacts
    credentialpath = ../credentials/gcp-dvc-key.json
```

---

## Archivos Creados/Modificados

| Archivo | Descripción |
|---------|-------------|
| `.dvc/config` | Configuración de DVC con remote GCS |
| `.dvcignore` | Archivos a ignorar por DVC |
| `credentials/gcp-dvc-key.json` | Credenciales Service Account (no en Git) |
| `scripts/verify_dvc.py` | Script de verificación de configuración |
| `tests/integration/test_dvc_integration.py` | Tests de integración DVC |
| `.gitignore` | Actualizado para ignorar credenciales |
| `.env.example` | Actualizado con variables GCS |
| `data/test/sample_blocks.csv.dvc` | Archivo de prueba versionado |

---

## Comandos de Referencia

```powershell
# Agregar archivo a DVC
poetry run dvc add <archivo>

# Push a GCS
poetry run dvc push

# Pull desde GCS
poetry run dvc pull

# Ver status
poetry run dvc status

# Verificar configuración
poetry run dvc remote list
poetry run dvc config -l

# Ejecutar script de verificación
poetry run python scripts/verify_dvc.py

# Ejecutar tests de integración
poetry run pytest tests/integration/test_dvc_integration.py -v
```

---

## Tests Ejecutados

```
tests/integration/test_dvc_integration.py::TestDVCIntegration::test_dvc_is_initialized PASSED
tests/integration/test_dvc_integration.py::TestDVCIntegration::test_dvc_remote_configured PASSED
tests/integration/test_dvc_integration.py::TestDVCIntegration::test_dvc_version_has_gs_support PASSED
tests/integration/test_dvc_integration.py::TestDVCIntegration::test_dvc_status_runs PASSED
tests/integration/test_dvc_integration.py::TestDVCIntegration::test_credentials_file_exists PASSED
tests/integration/test_dvc_integration.py::TestDVCIntegration::test_dvcignore_exists PASSED
```

---

## Dependencias Agregadas

```toml
dvc-gs = "^3.0.2"
```

---

## Notas

- El proyecto GCP utilizado es `a`
- Las credenciales deben configurarse localmente en `credentials/gcp-dvc-key.json`
- El ciclo completo `add → push → rm → pull` fue verificado exitosamente
