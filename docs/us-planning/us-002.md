# Planificaci√≥n US-002: Inicializaci√≥n de DVC y GCS

> **Estado:** üìã Planificaci√≥n
> **Sprint:** 1 - Fundamentos y Adquisici√≥n de Datos
> **Puntos de Historia:** 2 (4 horas estimadas)
> **Fecha de Planificaci√≥n:** 2025-11-28

---

## üìã Historia de Usuario

**Como** ML Engineer
**Quiero** versionar datos y modelos en la nube
**Para** mantener trazabilidad de experimentos y reproducibilidad del pipeline

---

## ‚úÖ Criterios de Aceptaci√≥n

- [ ] DVC inicializado en el repositorio (`.dvc/` configurado)
- [ ] Bucket GCS creado: `gs://geo-rect-artifacts`
- [ ] Lifecycle policy configurada (30 d√≠as para objetos temporales)
- [ ] DVC remote configurado apuntando a GCS como default
- [ ] Service Account con permisos m√≠nimos (Storage Object Admin)
- [ ] Credenciales GCP configuradas de forma segura (no en Git)
- [ ] Ciclo completo funcional: `dvc add` ‚Üí `dvc push` ‚Üí `rm` ‚Üí `dvc pull`
- [ ] Documentaci√≥n de comandos y configuraci√≥n

---

## üèóÔ∏è Plan de Implementaci√≥n

### Fase 1: Configuraci√≥n de GCP y Bucket GCS (45 min)

#### 1.1 Crear Proyecto GCP (si no existe)

```powershell
# Verificar gcloud instalado
gcloud --version

# Autenticarse
gcloud auth login

# Crear proyecto (si es necesario)
gcloud projects create geo-rect-prod --name="Geo-Rect Production"

# Establecer proyecto activo
gcloud config set project geo-rect-prod

# Habilitar APIs necesarias
gcloud services enable storage.googleapis.com
gcloud services enable secretmanager.googleapis.com
```

#### 1.2 Crear Bucket GCS con Lifecycle Policy

```powershell
# Crear bucket en us-central1 (regi√≥n econ√≥mica)
gcloud storage buckets create gs://geo-rect-artifacts `
    --location=us-central1 `
    --storage-class=STANDARD `
    --uniform-bucket-level-access

# Verificar creaci√≥n
gcloud storage buckets describe gs://geo-rect-artifacts
```

#### 1.3 Configurar Lifecycle Policy

Crear archivo `lifecycle.json`:

```json
{
  "lifecycle": {
    "rule": [
      {
        "action": {"type": "Delete"},
        "condition": {
          "age": 30,
          "matchesPrefix": ["tmp/", "cache/"]
        }
      },
      {
        "action": {"type": "SetStorageClass", "storageClass": "NEARLINE"},
        "condition": {
          "age": 90,
          "matchesPrefix": ["data/raw/", "models/archive/"]
        }
      }
    ]
  }
}
```

```powershell
# Aplicar lifecycle policy
gcloud storage buckets update gs://geo-rect-artifacts --lifecycle-file=lifecycle.json
```

---

### Fase 2: Configuraci√≥n de Service Account (30 min)

#### 2.1 Crear Service Account con Permisos M√≠nimos

```powershell
# Crear service account
gcloud iam service-accounts create geo-rect-dvc `
    --display-name="Geo-Rect DVC Service Account" `
    --description="Service account for DVC data versioning"

# Asignar rol Storage Object Admin (m√≠nimo necesario para DVC)
gcloud projects add-iam-policy-binding geo-rect-prod `
    --member="serviceAccount:geo-rect-dvc@geo-rect-prod.iam.gserviceaccount.com" `
    --role="roles/storage.objectAdmin" `
    --condition=None

# Generar key JSON
gcloud iam service-accounts keys create credentials/gcp-dvc-key.json `
    --iam-account=geo-rect-dvc@geo-rect-prod.iam.gserviceaccount.com
```

#### 2.2 Configurar Credenciales de Forma Segura

**Opci√≥n A: Variable de entorno (desarrollo local)**

```powershell
# Agregar a .env (NO commitear)
$env:GOOGLE_APPLICATION_CREDENTIALS = "C:\Users\arthu\Proyectos\INE\manzanasDispares\credentials\gcp-dvc-key.json"

# Verificar
echo $env:GOOGLE_APPLICATION_CREDENTIALS
```

**Opci√≥n B: Secret Manager (producci√≥n/CI)**

```powershell
# Crear secreto en Secret Manager
gcloud secrets create geo-rect-dvc-credentials `
    --data-file=credentials/gcp-dvc-key.json

# Dar acceso al service account
gcloud secrets add-iam-policy-binding geo-rect-dvc-credentials `
    --member="serviceAccount:geo-rect-dvc@geo-rect-prod.iam.gserviceaccount.com" `
    --role="roles/secretmanager.secretAccessor"
```

#### 2.3 Actualizar .gitignore

```gitignore
# Credentials (NUNCA commitear)
credentials/
*.json
!package.json
!lifecycle.json
gcp-*.json
*-key.json
```

---

### Fase 3: Inicializaci√≥n de DVC (30 min)

#### 3.1 Inicializar DVC en el Repositorio

```powershell
# Navegar al proyecto
cd c:\Users\arthu\Proyectos\INE\manzanasDispares

# Inicializar DVC
poetry run dvc init

# Verificar estructura creada
Get-ChildItem .dvc -Recurse
```

**Estructura esperada:**
```
.dvc/
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ config
‚îî‚îÄ‚îÄ tmp/
```

#### 3.2 Configurar Remote GCS como Default

```powershell
# Agregar remote GCS
poetry run dvc remote add -d storage gs://geo-rect-artifacts

# Configurar credenciales para el remote
poetry run dvc remote modify storage credentialpath credentials/gcp-dvc-key.json

# Verificar configuraci√≥n
poetry run dvc remote list
poetry run dvc config -l
```

**Archivo `.dvc/config` esperado:**
```ini
[core]
    remote = storage
    autostage = true
['remote "storage"']
    url = gs://geo-rect-artifacts
    credentialpath = credentials/gcp-dvc-key.json
```

#### 3.3 Configuraciones Adicionales de DVC

```powershell
# Habilitar autostage (auto git add de .dvc files)
poetry run dvc config core.autostage true

# Configurar cache local
poetry run dvc config cache.local .dvc/cache

# Configurar tipo de cache (symlink para ahorrar espacio)
poetry run dvc config cache.type symlink
```

---

### Fase 4: Prueba del Ciclo Completo (45 min)

#### 4.1 Crear Archivo de Prueba

```powershell
# Crear directorio de datos de prueba
New-Item -ItemType Directory -Path data/test -Force

# Crear archivo de prueba (simular dataset)
$testContent = @"
id,lat,lon,label
1,19.4326,-99.1332,aligned
2,19.4327,-99.1333,misaligned
3,19.4328,-99.1334,semantic_change
"@
$testContent | Out-File -FilePath data/test/sample_blocks.csv -Encoding utf8
```

#### 4.2 Ejecutar Ciclo DVC Completo

```powershell
# 1. Agregar archivo a DVC
poetry run dvc add data/test/sample_blocks.csv

# Verificar archivos creados
Get-ChildItem data/test/

# Esperado:
# - sample_blocks.csv.dvc (metadatos)
# - .gitignore (ignora el archivo original)

# 2. Commit de metadatos a Git
git add data/test/sample_blocks.csv.dvc data/test/.gitignore
git commit -m "data: add sample blocks test file (DVC)"

# 3. Push a GCS
poetry run dvc push

# Verificar en GCS
gcloud storage ls gs://geo-rect-artifacts/

# 4. Simular p√©rdida de datos (eliminar local)
Remove-Item data/test/sample_blocks.csv -Force

# Verificar que se elimin√≥
Test-Path data/test/sample_blocks.csv  # Debe ser False

# 5. Recuperar desde GCS
poetry run dvc pull

# Verificar recuperaci√≥n
Test-Path data/test/sample_blocks.csv  # Debe ser True
Get-Content data/test/sample_blocks.csv
```

#### 4.3 Verificar Integridad

```powershell
# Verificar status de DVC
poetry run dvc status

# Verificar checksum
poetry run dvc diff
```

---

### Fase 5: Configuraci√≥n de Estructura de Datos (30 min)

#### 5.1 Crear Estructura de Directorios para DVC

```powershell
# Crear estructura de datos
$directories = @(
    "data/raw/satellite_tiles",
    "data/raw/vectors",
    "data/processed/aligned",
    "data/processed/features",
    "data/labeled/train",
    "data/labeled/val",
    "data/cache",
    "models/dinov2",
    "models/loftr",
    "models/xgboost"
)

foreach ($dir in $directories) {
    New-Item -ItemType Directory -Path $dir -Force
    # Crear .gitkeep para mantener estructura en Git
    New-Item -ItemType File -Path "$dir/.gitkeep" -Force
}
```

#### 5.2 Configurar .dvcignore

Crear archivo `.dvcignore` en la ra√≠z:

```
# Ignorar archivos temporales
*.tmp
*.temp
*.log

# Ignorar checkpoints de notebooks
.ipynb_checkpoints/

# Ignorar cache de Python
__pycache__/
*.pyc

# Ignorar archivos de sistema
.DS_Store
Thumbs.db

# Ignorar archivos peque√±os de configuraci√≥n
*.yaml
*.yml
*.json
*.toml
!dvc.yaml
!dvc.lock
```

---

### Fase 6: Documentaci√≥n y Scripts de Utilidad (30 min)

#### 6.1 Script de Verificaci√≥n DVC

Crear `scripts/verify_dvc.py`:

```python
"""
Script to verify DVC and GCS configuration.

This script checks DVC initialization, remote configuration, and GCS connectivity.
"""

import subprocess
import sys
from pathlib import Path


def run_command(cmd: list[str]) -> tuple[bool, str]:
    """Run a shell command and return success status and output."""
    try:
        result = subprocess.run(cmd, capture_output=True, text=True, check=True)
        return True, result.stdout.strip()
    except subprocess.CalledProcessError as e:
        return False, e.stderr.strip()
    except FileNotFoundError:
        return False, f"Command not found: {cmd[0]}"


def check_dvc_init() -> bool:
    """Check if DVC is initialized."""
    dvc_dir = Path(".dvc")
    if dvc_dir.exists() and dvc_dir.is_dir():
        print("DVC initialized: YES")
        return True
    print("DVC initialized: NO")
    return False


def check_dvc_remote() -> bool:
    """Check DVC remote configuration."""
    success, output = run_command(["dvc", "remote", "list"])
    if success and "storage" in output:
        print(f"DVC remote configured: YES")
        print(f"  Remote: {output}")
        return True
    print("DVC remote configured: NO")
    return False


def check_gcs_connectivity() -> bool:
    """Check GCS bucket connectivity."""
    success, output = run_command(
        ["gcloud", "storage", "ls", "gs://geo-rect-artifacts/"]
    )
    if success:
        print("GCS connectivity: OK")
        return True
    print(f"GCS connectivity: FAILED - {output}")
    return False


def check_dvc_status() -> bool:
    """Check DVC status."""
    success, output = run_command(["dvc", "status"])
    if success:
        print(f"DVC status: OK")
        if output:
            print(f"  {output}")
        return True
    print(f"DVC status: FAILED - {output}")
    return False


def main() -> int:
    """Run all DVC verification checks."""
    print("=" * 60)
    print("Geo-Rect DVC Verification Script")
    print("=" * 60)

    checks = [
        ("DVC Initialization", check_dvc_init),
        ("DVC Remote", check_dvc_remote),
        ("GCS Connectivity", check_gcs_connectivity),
        ("DVC Status", check_dvc_status),
    ]

    results = []
    for name, check_func in checks:
        print(f"\n--- {name} ---")
        results.append((name, check_func()))

    print("\n" + "=" * 60)
    print("Summary:")
    print("=" * 60)

    all_passed = True
    for name, passed in results:
        status = "PASSED" if passed else "FAILED"
        print(f"  {name}: {status}")
        if not passed:
            all_passed = False

    return 0 if all_passed else 1


if __name__ == "__main__":
    sys.exit(main())
```

#### 6.2 Actualizar .env.example

Agregar variables de DVC/GCS:

```bash
# DVC / GCS Configuration
GCS_BUCKET=geo-rect-artifacts
GOOGLE_APPLICATION_CREDENTIALS=credentials/gcp-dvc-key.json
DVC_REMOTE=gs://geo-rect-artifacts
```

---

## üß™ Plan de Pruebas

### Tests de Verificaci√≥n

| ID | Prueba | Comando | Resultado Esperado |
|----|--------|---------|-------------------|
| T1 | DVC instalado | `poetry run dvc version` | >= 3.56.0 |
| T2 | DVC inicializado | `Test-Path .dvc` | True |
| T3 | Remote configurado | `poetry run dvc remote list` | `storage gs://geo-rect-artifacts` |
| T4 | GCS accesible | `gcloud storage ls gs://geo-rect-artifacts/` | Sin errores |
| T5 | dvc add funciona | `poetry run dvc add data/test/sample.csv` | Crea .dvc file |
| T6 | dvc push funciona | `poetry run dvc push` | Upload exitoso |
| T7 | dvc pull funciona | `poetry run dvc pull` | Download exitoso |
| T8 | Ciclo completo | add ‚Üí push ‚Üí rm ‚Üí pull | Archivo recuperado |

### Test de Integraci√≥n

```python
"""Test DVC integration with GCS."""

import subprocess
from pathlib import Path

import pytest


class TestDVCIntegration:
    """Integration tests for DVC and GCS."""

    @pytest.fixture
    def test_file(self, tmp_path: Path) -> Path:
        """Create a temporary test file."""
        test_file = tmp_path / "test_data.csv"
        test_file.write_text("id,value\n1,100\n2,200\n")
        return test_file

    def test_dvc_is_initialized(self):
        """Verify DVC is initialized in the repository."""
        assert Path(".dvc").exists()
        assert Path(".dvc/config").exists()

    def test_dvc_remote_configured(self):
        """Verify DVC remote is configured."""
        result = subprocess.run(
            ["dvc", "remote", "list"],
            capture_output=True,
            text=True,
        )
        assert "storage" in result.stdout
        assert "gs://geo-rect-artifacts" in result.stdout

    def test_dvc_version(self):
        """Verify DVC version is compatible."""
        result = subprocess.run(
            ["dvc", "version"],
            capture_output=True,
            text=True,
        )
        assert result.returncode == 0
```

---

## üìä M√©tricas de √âxito

| M√©trica | Criterio | Estado |
|---------|----------|--------|
| DVC inicializado | `.dvc/` existe con config v√°lida | ‚¨ú |
| Bucket GCS creado | `gs://geo-rect-artifacts` accesible | ‚¨ú |
| Lifecycle policy | Objetos tmp/* eliminados a 30 d√≠as | ‚¨ú |
| Remote configurado | `dvc remote list` muestra storage | ‚¨ú |
| Service Account | Permisos m√≠nimos (Storage Object Admin) | ‚¨ú |
| Credenciales seguras | No en Git, en .env o Secret Manager | ‚¨ú |
| Ciclo completo | add ‚Üí push ‚Üí rm ‚Üí pull funciona | ‚¨ú |
| Script verificaci√≥n | `verify_dvc.py` pasa todos los checks | ‚¨ú |

---

## ‚ö†Ô∏è Riesgos y Mitigaciones

| Riesgo | Probabilidad | Impacto | Mitigaci√≥n |
|--------|--------------|---------|------------|
| Credenciales en Git | Media | Cr√≠tico | Pre-commit hook para detectar keys, .gitignore estricto |
| Bucket p√∫blico accidentalmente | Baja | Cr√≠tico | Uniform bucket-level access, IAM restrictivo |
| Costos inesperados GCS | Baja | Medio | Lifecycle policy, billing alerts, presupuesto $300 |
| Conflictos DVC/Git | Media | Bajo | Autostage habilitado, workflow documentado |
| P√©rdida de credenciales | Baja | Alto | Backup en Secret Manager, rotaci√≥n de keys |

---

## üìÖ Cronograma Detallado

| Fase | Tarea | Duraci√≥n | Acumulado |
|------|-------|----------|-----------|
| 1 | Configuraci√≥n GCP y Bucket | 45 min | 0:45 |
| 2 | Service Account y credenciales | 30 min | 1:15 |
| 3 | Inicializaci√≥n DVC | 30 min | 1:45 |
| 4 | Prueba ciclo completo | 45 min | 2:30 |
| 5 | Estructura de datos | 30 min | 3:00 |
| 6 | Documentaci√≥n y scripts | 30 min | 3:30 |
| 7 | Testing y ajustes | 30 min | 4:00 |

**Total estimado:** 4 horas (2 puntos de historia)

---

## üìã Checklist Pre-Implementaci√≥n

- [ ] Cuenta GCP activa con billing habilitado
- [ ] gcloud CLI instalado y autenticado
- [ ] Poetry environment activo
- [ ] DVC instalado (`poetry run dvc version`)
- [ ] Permisos de administrador en GCP
- [ ] .gitignore actualizado para credenciales

---

## üéØ Entregables

1. **Bucket GCS** `gs://geo-rect-artifacts` con lifecycle policy
2. **Service Account** `geo-rect-dvc@geo-rect-prod.iam.gserviceaccount.com`
3. **DVC inicializado** con remote GCS configurado
4. **Script de verificaci√≥n** `scripts/verify_dvc.py`
5. **Estructura de directorios** para datos y modelos
6. **Documentaci√≥n** en `docs/us-resolved/us.002.md`
7. **Tests de integraci√≥n** para DVC/GCS

---

## üìù Comandos de Referencia R√°pida

```powershell
# Inicializaci√≥n
poetry run dvc init
poetry run dvc remote add -d storage gs://geo-rect-artifacts

# Operaciones b√°sicas
poetry run dvc add <file>
poetry run dvc push
poetry run dvc pull
poetry run dvc status

# Verificaci√≥n
poetry run dvc remote list
poetry run dvc config -l
gcloud storage ls gs://geo-rect-artifacts/

# Troubleshooting
poetry run dvc doctor
poetry run dvc cache dir
```

---

## üîó Dependencias con Otras US

| US | Relaci√≥n | Notas |
|----|----------|-------|
| US-001 | Prerrequisito | Entorno local configurado |
| US-003 | Dependiente | Cliente Google Maps usar√° DVC para cache |
| US-004 | Dependiente | Rasterizador guardar√° outputs en DVC |
| US-007 | Dependiente | Modelos entrenados versionados con DVC |

---

**Documento creado:** 2025-11-28
**Autor:** Kiro AI + Arthur Zizumbo
**Versi√≥n:** 1.0
